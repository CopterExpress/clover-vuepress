import{_ as i,r as l,o as c,c as d,a as t,b as n,w as s,F as r,d as e,e as a}from"./app.4f6a4bec.js";const _={},p=t("h1",{id:"use-of-optical-flow",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#use-of-optical-flow","aria-hidden":"true"},"#"),e(" Use of Optical Flow")],-1),h=t("p",null,'Running the "Optical Flow" function offers the possibility of POSCTL flight mode, and autonomous flight operating on a camera pointed downwards that detects changes of ground texture.',-1),u=t("h2",{id:"enabling",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#enabling","aria-hidden":"true"},"#"),e(" Enabling")],-1),f={class:"custom-container tip"},g=t("p",{class:"custom-container-title"},"TIP",-1),m=e("For Optical Flow to work it's required that the laser rangefinder is "),E=e("connected and configured"),k=e("."),F=a(`<p>Enable Optical Flow in the file <code>~/catkin_ws/src/clover/clover/launch/clover.launch</code>:</p><div class="language-xml ext-xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>optical_flow<span class="token punctuation">&quot;</span></span> <span class="token attr-name">default</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre></div>`,2),b=e("Optical Flow publishes data in "),v=t("code",null,"/mavros/px4flow/raw/send",-1),w=e(" topic. In the topic "),L=t("code",null,"/optical_flow/debug",-1),O=e(" is also published a visualization, that can be viewed with "),S=e("web_video_server"),P=e("."),T={class:"custom-container tip"},y=t("p",{class:"custom-container-title"},"TIP",-1),N=e("Correct connection and "),x=e("setup"),I=e(" of the camera module is needed for proper functioning."),M=t("h2",{id:"setup-of-the-flight-controller",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#setup-of-the-flight-controller","aria-hidden":"true"},"#"),e(" Setup of the flight controller")],-1),C={class:"custom-container tip"},R=t("p",{class:"custom-container-title"},"TIP",-1),A=e("Suggested parameters are applied automatically in "),K=e("our custom PX4 firmware"),V=e("."),W=t("p",null,[e("When using "),t("strong",null,"EKF2"),e(" (parameter "),t("code",null,"SYS_MC_EST_GROUP"),e(" = "),t("code",null,"ekf2"),e("):")],-1),G=a("<li><code>EKF2_AID_MASK</code> \u2013 flag &#39;use optical flow&#39; is on.</li><li><code>EKF2_OF_DELAY</code> \u2013\xA00.</li><li><code>EKF2_OF_QMIN</code> \u2013 10.</li><li><code>EKF2_OF_N_MIN</code> \u2013\xA00.05.</li><li><code>EKF2_OF_N_MAX</code> - 0.2.</li><li><code>SENS_FLOW_ROT</code> \u2013 No rotation.</li><li><code>SENS_FLOW_MAXHGT</code> \u2013 4.0 (for the rangefinder VL53L1X)</li><li><code>SENS_FLOW_MINHGT</code> \u2013 0.0 (for the rangefinder VL53L1X)</li>",8),X=e("Optional: "),q=t("code",null,"EKF2_HGT_MODE",-1),H=e(" \u2013 range sensor (cf. "),Y=e("rangefinder setup"),U=e(")."),D=t("p",null,[e("When using "),t("strong",null,"LPE"),e(" (parameter "),t("code",null,"SYS_MC_EST_GROUP"),e(" = "),t("code",null,"local_position_estimator, attitude_estimator_q"),e("):")],-1),B=a("<li><code>LPE_FUSION</code> \u2013 flags &#39;fuse optical flow&#39; and &#39;flow gyro compensation&#39; are on.</li><li><code>LPE_FLW_QMIN</code> \u2013 10.</li><li><code>LPE_FLW_SCALE</code> \u2013 1.0.</li><li><code>LPE_FLW_R</code> \u2013 0.2.</li><li><code>LPE_FLW_RR</code> \u2013 0.0.</li><li><code>SENS_FLOW_ROT</code> \u2013 No rotation.</li><li><code>SENS_FLOW_MAXHGT</code> \u2013 4.0 (for the rangefinder VL53L1X)</li><li><code>SENS_FLOW_MINHGT</code> \u2013 0.0 (for the rangefinder VL53L1X)</li>",8),z=e("Optional: "),Z=t("code",null,"LPE_FUSION",-1),Q=e(" \u2013 flag 'pub agl as lpos down' is on (see "),j=e("rangefinder setup"),J=e("."),$=e("The "),ee=t("code",null,"selfcheck.py",-1),te=e(" utility"),oe=e(" will help you verify that all settings are correctly set."),ne=t("h2",{id:"posctl-flight",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#posctl-flight","aria-hidden":"true"},"#"),e(" POSCTL flight")],-1),se=t("p",null,"Setup POSCTL to be one of PX4 flight modes and then select POSCTL.",-1),ae=t("h2",{id:"autonomous-flight",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#autonomous-flight","aria-hidden":"true"},"#"),e(" Autonomous flight")],-1),ie=e("The module "),le=e("simple_offboard"),ce=e(" enables autonomous flight."),de=a(`<p>Example of take off and leveling at 1.5m above the ground:</p><div class="language-python ext-py"><pre class="language-python"><code>navigate<span class="token punctuation">(</span>z<span class="token operator">=</span><span class="token number">1.5</span><span class="token punctuation">,</span> frame_id<span class="token operator">=</span><span class="token string">&#39;body&#39;</span><span class="token punctuation">,</span> auto_arm<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre></div><p>Flying forward for 1m:</p><div class="language-python ext-py"><pre class="language-python"><code>navigate<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">1.5</span><span class="token punctuation">,</span> frame_id<span class="token operator">=</span><span class="token string">&#39;body&#39;</span><span class="token punctuation">)</span>
</code></pre></div>`,4),re=e("Navigation using ArUco-markers"),_e=e(" and [using VPE] are available when using Optical Flow."),pe=a('<h2 id="additional-settings" tabindex="-1"><a class="header-anchor" href="#additional-settings" aria-hidden="true">#</a> Additional settings</h2><p>If the copter has an unstable position, try to increase the <em>P</em> coefficient of speed PID controller - parameters are <code>MPC_XY_VEL_P</code> and <code>MPC_Z_VEL_P</code>.</p><p>If the copter has an unstable height, try increasing <code>MPC_Z_VEL_P</code> coefficient or getting better hover throttle - <code>MPC_THR_HOVER</code>.</p><p>If the copter is consistently yawing, try:</p><ul><li>recalibrate gyroscopes;</li><li>recalibrate magnetometer;</li><li>different values for <code>EKF2_MAG_TYPE</code> parameter, that indicates how data from the magnetometer is used in EKF2;</li><li>changing values of <code>EKF2_MAG_NOISE</code>, <code>EKF2_GYR_NOISE</code>, <code>EKF2_GYR_B_NOISE</code> parameters.</li></ul>',5),he={class:"custom-container tip"},ue=t("p",{class:"custom-container-title"},"TIP",-1),fe=e("For better results perform gyro calibration directly before taking off, using "),ge=e("appropriate snippet"),me=e("."),Ee=a(`<p>If the copter&#39;s height is deviating, try:</p><ul><li>increasing the value of <code>MPC_Z_VEL_P</code> coefficient;</li><li>change the value of <code>MPC_THR_HOVER</code> parameter;</li><li>add <code>MPC_ALT_MODE</code> = 2 (Terrain following).</li></ul><p>When using Optical Flow, the maximal horizontal speed is further limited. This is an indirect influence of the parameter <code>SENS_FLOW_MAXR</code> (maximal reliable &quot;angular speed&quot; of the optical flow). In normal flight mode, control loops will be adjusted so that Optical Flow values do not exceed 50% of this parameter.</p><h2 id="errors" tabindex="-1"><a class="header-anchor" href="#errors" aria-hidden="true">#</a> Errors</h2><p>If errors like <code>EKF INTERNAL CHECKS</code> occur, try to restart EKF2. To do so, enter in the MAVLink-console:</p><div class="language-nsh ext-nsh"><pre class="language-nsh"><code>ekf2 stop
ekf2 start
</code></pre></div>`,6);function ke(Fe,be){const o=l("RouterLink");return c(),d(r,null,[p,h,u,t("div",f,[g,t("p",null,[m,n(o,{to:"/en/laser.html"},{default:s(()=>[E]),_:1}),k])]),F,t("p",null,[b,v,w,L,O,n(o,{to:"/en/web_video_server.html"},{default:s(()=>[S]),_:1}),P]),t("div",T,[y,t("p",null,[N,n(o,{to:"/en/camera.html"},{default:s(()=>[x]),_:1}),I])]),M,t("div",C,[R,t("p",null,[A,n(o,{to:"/en/firmware.html#modified-firmware-for-clover"},{default:s(()=>[K]),_:1}),V])]),W,t("ul",null,[G,t("li",null,[X,q,H,n(o,{to:"/en/laser.html"},{default:s(()=>[Y]),_:1}),U])]),D,t("ul",null,[B,t("li",null,[z,Z,Q,n(o,{to:"/en/laser.html"},{default:s(()=>[j]),_:1}),J])]),t("p",null,[n(o,{to:"/en/selfcheck.html"},{default:s(()=>[$,ee,te]),_:1}),oe]),ne,se,ae,t("p",null,[ie,n(o,{to:"/en/simple_offboard.html"},{default:s(()=>[le]),_:1}),ce]),de,t("p",null,[n(o,{to:"/en/aruco_marker.html"},{default:s(()=>[re]),_:1}),_e]),pe,t("div",he,[ue,t("p",null,[fe,n(o,{to:"/en/snippets.html#calibrate-gyro"},{default:s(()=>[ge]),_:1}),me])]),Ee],64)}var we=i(_,[["render",ke],["__file","optical_flow.html.vue"]]);export{we as default};
